<!DOCTYPE html>
<html>
    <head>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js" type="text/javascript"></script>
    </head>

    <body>
        <div class="container">
            <div class="row shadow mt-4">
                <div class="badge" style="background-color: rgb(213, 248, 145);">
                    <p class="fs-3" style="color: black;">Room {{room_client_info['room_id']}} matched: Worker {{room_client_info['speaker_1']}} and Worker {{room_client_info['speaker_2']}}</p> 
                </div>
            </div>

            <div class="row mt-4">
                <div class="col-3">
                    <p>
                        Here goes the instruciton.
                    </p>
                    <input type="button" name="report" value="Report"/>
                    <label for="report">If your matched partner spoke something offensive,
                        you can click this button to report. The more details you could provide,
                        the quicker we could handle your report.
                    </label>
                </div>

                <div class="col-9 align-self-end">
                    <div class="row">
                        <div class="d-inline-block" style="height: 800px; background-color: bisque;" id="message_history">
                            <input type="hidden" id="counter" name="counter" value="0"/>
                        </div>
                    </div>
                    <!-- <form action="/message/update" id="messageform" method="post"> -->
                    <div class="row">
                        <textarea id="message_area" class="form-control"></textarea>
                    </div>
                    <div class="row">
                        <input class="btn button-primary" type="button" name="send_message" id="send_message" value="Send"/>
                        <input type="hidden" id="workerId" value="{{room_client_info['worker_id']}}"/>
                        <input type="hidden" id="roomId" value="{{room_client_info['room_id']}}"/>
                    </div>
                </div>
            </div>
        </div>

        <script type="text/javascript">
            $('#send_message').on("click", function (e) {
                e.preventDefault();
                $.ajax({
                    type: "POST",
                    url: `/message/new/id/${$("#roomId").val()}`,
                    data: {
                        workerId: $("#workerId").val(),
                        roomId: $("roomId").val(),
                        message: $("#message_area").val(),
                    },
                    success: function(result){
                        alert("done");
                        document.getElementById("message_area").value = '';
                    },
                    error: function(result) {
                        alert('error');
                    }
                });
            });

            var current_count = 0;

            $(document).ready(function (){
                setInterval(function () {
                    $.ajax({
                        type: "POST",
                        url: `/message/update/id/${$("#roomId").val()}`,
                        data: {
                            // workerId: $("#workerId").val(),
                            currentCount: current_count,
                            roomId: $("roomId").val(),
                            // message: $("#message_area").val(),
                        },
                        success: function(result){
                            // alert('got messagesData')
                            if (result.messages.length > current_count){
                                alert(current_count);
                                current_count += result.messages.length;
                                for (var i = 0; i< result.messages.length; i++) {
                                   var node = `<div>${result.messages[i].speaker} : ${result.messages[i].text} </div>`;
                                   $('#message_history').append(node);
                                   node.slideDown();
                                }
                                // alert(current_count);
                            }
                        },
                        error: function(result) {
                            alert('error');
                        }
                    });
                }, 1000 * 10);
            });
        </script>
    </body>
</html>